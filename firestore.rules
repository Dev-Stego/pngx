rules_version = '2';
// Updated rules deployment timestamp: 2026-01-24T00:15:00
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    // Now we check for the custom claim set by our API
    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin(); // Admins can ban/suspend
      allow delete: if isAdmin();
    }

    // --- COLLECTION GROUP RULES ---
    // These allow admins to query ALL history/shares across the entire database
    
    // Recursive match for any 'history' collection
    match /{path=**}/history/{historyId} {
      allow read: if isOwner(path[1]) || isAdmin(); // path[1] is typically userId in /users/{userId}/history
      allow write: if isOwner(path[1]) || isAdmin();
    }
    
    // Recursive match for any 'shares' collection (though shares are currently top-level, this future-proofs it)
    match /{path=**}/shares/{shareId} {
      allow read: if true; // Public read
      allow write: if (isAuthenticated() && resource.data.ownerId == request.auth.uid) || isAdmin();
    }

    // Standard Top-Level Matches (Specific)
    
    // Wallets collection
    match /wallets/{walletAddress} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.uid == request.auth.uid;
    }
    
    // Share links (Top-level)
    match /shares/{shareId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
    }
    
    // Admins collection - SECURED
    match /admins/{adminId} {
      // Only admins can read the admin list
      allow read: if isAdmin();
      // Only admins can update their own data or others (if Super Admin)
      // For simplicity, allow any admin to write here for now, or restrict further if needed.
      allow write: if isAdmin(); 
    }
    
    // Daily stats
    match /logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin(); // Server-side admin can write
    }

    match /stats/{statId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // System settings
    match /settings/{settingId} {
      allow read: if true; // Publicly readable for auth checks
      allow write: if isAdmin();
    }
  }
}
